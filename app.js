const { createBot, createProvider, createFlow, addKeyword, EVENTS } = require('@bot-whatsapp/bot');
const QRPortalWeb = require('@bot-whatsapp/portal');
const BaileysProvider = require('@bot-whatsapp/provider/baileys');
const MockAdapter = require('@bot-whatsapp/database/mock');
const path = require("path");
const fs = require("fs");

//..............GRACIAS.............//
// Palabras clave de agradecimiento
const palabrasAgradecimiento = ['gracias', 'muchas gracias', 'gracias a ti', 'mil gracias'];
// Flujo de agradecimiento
const flowGracias = addKeyword(palabrasAgradecimiento)
    .addAnswer('üòä ¬°Gracias a ti! Nos alegra haber podido ayudarte. ¬°Que tengas un excelente d√≠a!', null, async (_, { flowDynamic }) => {
        await flowDynamic(['üëã ¬°Hasta pronto!']);
    });

//...............VALIDAR HORARIO.........//
const obtenerHoraColombia = () => {
    const fechaActual = new Date();
    const opciones = { timeZone: 'America/Bogota' };
    const fechaColombia = new Date(fechaActual.toLocaleString('en-US', opciones));

    const diaSemana = fechaColombia.getDay(); // 0 = Domingo, ..., 6 = S√°bado
    const hora = fechaColombia.getHours();   // Hora en Colombia
    return { diaSemana, hora };
};

const validarHorarioLaboral = () => {
    const { diaSemana, hora } = obtenerHoraColombia();
    console.log(`D√≠a: ${diaSemana}, Hora: ${hora}`); // Log para depurar

    // Horarios laborales seg√∫n el d√≠a
    const horarios = {
        1: { inicio: 7, fin: 18 }, // Lunes
        2: { inicio: 7, fin: 18 }, // Martes
        3: { inicio: 7, fin: 18 }, // Mi√©rcoles
        4: { inicio: 7, fin: 17 }, // Jueves
        5: { inicio: 7, fin: 17 }, // Viernes
        6: { inicio: 8, fin: 11.75 }, // S√°bado (11.75 representa 11:45 a.m.)
        7: { inicio: 0, fin: 0 } // Domingo (cerrado)
    };

    // Validar si el d√≠a est√° dentro de los horarios definidos
    const horarioDia = horarios[diaSemana];
    if (!horarioDia) {
        console.log('D√≠a fuera del horario laboral.');
        return false;
    }

    // Validar si la hora est√° dentro del rango definido
    const esHorarioLaboral = hora >= horarioDia.inicio && hora < horarioDia.fin;
    console.log(`Es d√≠a laboral: ${!!horarioDia}, Es horario laboral: ${esHorarioLaboral}`);
    return esHorarioLaboral;
};


//...................OPCIONES DEL MENU................//
// üîπ Flujo de Asesor√≠a (Redirige al submen√∫)
const flowAsesor = addKeyword(EVENTS.ACTION)
    .addAnswer("üìû *Hablar con un Asesor*", null, async (_, { flowDynamic, gotoFlow }) => {
        if (!validarHorarioLaboral()) {
            await flowDynamic([
                '‚è≥ *Fuera de horario laboral*\n'+
                'üïí Nuestro horario de atenci√≥n es:\n'+
                '‚Ä¢ Lunes a Viernes: de 7:00 AM a 6:00 PM\n'+
                '‚Ä¢ Jueves y Viernes (horario especial): de 7:00 AM a 5:00 PM\n'+
                '‚Ä¢ S√°bado: de 8:00 AM a 11:45 AM\n'+
                '‚Ä¢ Domingo: Cerrado\n'+
                'üìå Deja tu consulta y un asesor te atender√° en el siguiente d√≠a h√°bil.'
            ]);
        } else {
            await flowDynamic('‚úÖ Estamos en horario laboral. Puedes contactarte con un asesor.');
        }

        return gotoFlow(flowSubmenuAsesor); // ‚úÖ Retorna correctamente al submen√∫
    });

// üîπ Submen√∫ del asesor
const flowSubmenuAsesor = addKeyword(['submenuasesor'])
    .addAnswer([
        'üìå *Selecciona una opci√≥n:*\n'+
        '\n1Ô∏è‚É£ *Asesor de Ventas*'+
        '\n2Ô∏è‚É£ *Asesor de Arriendos*'+
        '\n3Ô∏è‚É£ *Llamar a un Asesor*\n'+
        '\nüîô Escribe *volver* para regresar al men√∫ principal.'
    ], { capture: true }, async (ctx, { flowDynamic, gotoFlow }) => {
        if (ctx.body === '1') {
            await flowDynamic([
                '‚úÖ *Asesor de Ventas:*\n'+
                '\nüí¨ Contacta a *Laura*: https://wa.me/3016886282'+
                '\nüí¨ Contacta a *Ingrid*: https://wa.me/3156817798'
            ]);
        } else if (ctx.body === '2') {
            await flowDynamic([
                '‚úÖ *Asesor de Arriendos:*\n'+
                '\nüí¨ Contacta a *Alexandra*: https://wa.me/3005907784'
            ]);
        } else if (ctx.body === '3') {
            await flowDynamic([
                'üìû *Llamar a un Asesor*'+
                '\nüëâ *[Llamar ahora](tel:+573016886282)*'+
                '\nüëâ *[Llamar ahora](tel:+573156817798)*'
            ]);
        } else if (ctx.body.toLowerCase() === 'volver') {
            return gotoFlow(menuFlow); // ‚úÖ Ahora regresa correctamente al men√∫ principal
        } else {
            await flowDynamic('‚ùå Opci√≥n inv√°lida. Escribe *1*, *2*, *3* o *volver*.');
        }
    });
// Flujo de Quejas
const flowQuejas = addKeyword(EVENTS.ACTION)
    .addAnswer("Escribe *volver* para regresar al men√∫ principal.")
    .addAnswer([
        'üìã PQRSF',
        'Queremos mejorar nuestro servicio. Por favor, completa el formulario en el siguiente enlace para registrar tu PQRSF:',
        '\nüëâ(peticiones, quejas, reclamos, felicitaciones)(https://forms.gle/CdPQLxnKbotv4twY8)',
        '\n‚úÖ Una vez completado, nuestro equipo lo revisar√° y se pondr√° en contacto contigo. ¬°Gracias por ayudarnos a mejorar!']
    );


// Flujo de Cuenta
const flowCuenta = addKeyword(EVENTS.ACTION)
    .addAnswer("Escribe *volver* para regresar al men√∫ principal.")
    .addAnswer([
        'üîç Para consultar tu Estado de Cuenta, necesito que env√≠es un mensaje al siguiente correo con los siguientes datos:',
        '*Nombre:*'+
        '\n*Identificaci√≥n:*'+
        '\n*Nombre del proyecto:*'+
        '\n‚ö†Ô∏è Todo en un solo mensaje.'+
        '\nüìß *Correo:* Tesoreria@atlantisconstructora.com'+
        '\n‚úÖ Nuestro equipo revisar√° tu solicitud y te responder√° en breve.'
    ],
        null, async (_, { flowDynamic, gotoFlow }) => {
            manejarRedireccion(_, gotoFlow);
            if (validarHorarioLaboral()) {
                await flowDynamic('‚úÖ Estamos en horario laboral. Contacte al asesor y revisar√° tu solicitud pronto.');
            } else {
                await flowDynamic([
                    'Actualmente estamos fuera de servicio' +
                    'üïí Nuestro horario de atenci√≥n es el siguiente: \n' +
                    '‚Ä¢ Lunes a Viernes: de 7:00 AM a 6:00 PM\n' +
                    '‚Ä¢ Jueves y Viernes (horario especial): de 7:00 AM a 5:00 PM\n' +
                    '‚Ä¢ S√°bado: de 8:00 AM a 11:45 AM\n' +
                    '‚Ä¢ Domingo: Cerrado\n' +
                    'Deja tu consulta en el anterior link y un asesor te atender√° en el siguiente d√≠a h√°bil seg√∫n este horario.',
                ]);
            }
        });

// Flujo de Ventas
const flowVenta = addKeyword(EVENTS.ACTION)
    .addAnswer("Escribe *volver* para regresar al men√∫ principal.")
    .addAnswer(
        "üîç Para consultar nuestros proyectos disponibles, por favor visita nuestra p√°ginas en redes sociales:\n" +
        "üëâ [Facebook](https://www.facebook.com/AtlantisConstructora)\n" +
        "üëâ [Instagram](https://www.instagram.com/atlantisconstructora)"
    );

//....................MENU......................//

// Funci√≥n gen√©rica para manejar "volver" o "menu"
const manejarRedireccion = async (ctx, gotoFlow) => {
    if (ctx.body.toLowerCase() === "volver" || ctx.body.toLowerCase() === "menu") {
        return await gotoFlow(menuFlow);
    }
};

// Cargar el men√∫ desde un archivo
const menuPath = path.join(__dirname, "mensajes", "menu.txt");
const menu = fs.readFileSync(menuPath, "utf-8");
const menuFlow = addKeyword(["menu", "volver"])

    // Flujo del Men√∫
    .addAnswer(menu, { capture: true }, async (ctx, { gotoFlow, fallBack, flowDynamic }) => {
        manejarRedireccion(ctx, gotoFlow);
        const opcionesValidas = ["1", "2", "3", "4", "0"];
        if (!opcionesValidas.includes(ctx.body)) {
            return fallBack("‚ùå Opci√≥n no v√°lida. Por favor selecciona una opci√≥n v√°lida.");
        }

        switch (ctx.body) {
            case "1":
                return gotoFlow(flowVenta);
            case "2":
                return gotoFlow(flowAsesor);
            case "3":
                return gotoFlow(flowCuenta);
            case "4":
                return gotoFlow(flowQuejas);
            case "0":
                return await flowDynamic("Saliendo... Puedes volver al men√∫ escribiendo '*menu*'.");
        }
    });
//..................BIENVENIDAS....................//
// Flujo Principal 
const flowPrincipal = addKeyword(['hola', 'ole', 'alo'])
.addAnswer(["üôå ¬°Hola! Bienvenido a *Atlantis Constructora Ltda.*",
    "Gracias por contactarnos.",
    "Estamos aqu√≠ para ayudarte a construir tus sue√±os."
])
.addAnswer(
    "¬øCu√©ntanos en qu√© podemos ayudarte?", 
    { capture: true }, // Captura la respuesta del usuario
    async (ctx, { flowDynamic, gotoFlow }) => {
        // Captura lo que el usuario escribe
        const consultaUsuario = ctx.body;
        console.log(`Consulta del usuario: ${consultaUsuario}`);
    

        // Env√≠a el men√∫ despu√©s de la respuesta
        await flowDynamic("Aqu√≠ tienes nuestras opciones:");
        return gotoFlow(menuFlow); // Redirige al flujo del men√∫
    }
);

    const flowWelcome = addKeyword(EVENTS.WELCOME)
    .addAnswer(["üôå ¬°Hola! Bienvenido a *Atlantis Constructora Ltda.*",
        "Gracias por contactarnos.",
        "Estamos aqu√≠ para ayudarte a construir tus sue√±os."
    ])
    .addAnswer(
        "¬øCu√©ntanos en qu√© podemos ayudarte?", 
        { capture: true }, // Captura la respuesta del usuario
        async (ctx, { flowDynamic, gotoFlow }) => {
            // Captura lo que el usuario escribe
            const consultaUsuario = ctx.body;
            console.log(`Consulta del usuario: ${consultaUsuario}`);

            // Env√≠a el men√∫ despu√©s de la respuesta
            await flowDynamic("Aqu√≠ tienes nuestras opciones:");
            return gotoFlow(menuFlow); // Redirige al flujo del men√∫
         }
    );
// Inicializaci√≥n del Bot
const main = async () => {
    const adapterDB = new MockAdapter();
    const adapterFlow = createFlow([flowPrincipal, flowWelcome, menuFlow, flowVenta, flowCuenta, flowAsesor, flowQuejas, flowGracias, flowSubmenuAsesor]);
    const adapterProvider = createProvider(BaileysProvider);

    createBot({
        flow: adapterFlow,
        provider: adapterProvider,
        database: adapterDB,
    });

    QRPortalWeb();
};

main();
